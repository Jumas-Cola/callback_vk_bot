callback_vk_bot ![Python 3.6](https://pp.userapi.com/c846523/v846523407/b716d/N3RXKWFcPS0.jpg)
======
**callback_vk_bot** – простой callback-бот для группы на PHP для социальной сети Вконтакте (vk.com)

При получении сообщения с командой на отправку картинки, ищет контент в случайной группе из заданного списка и присылает пользовтелю.

Если сообщение не содержит ключевой фразы - отправляет заглушку с вашим текстом (благодарность за ожидание ответа например).

При выходе пользователя из группы, также отправляет ему сообщение (для этого пользователь должен хотя бы раз отправить сообщение в группу или разрешить отправку сообщений от данной группы).

Для работы программы необходимо заполнить следующие переменные:

```php
...
//...логин для пользовательской авторизации (необходим только для получения токена. если токен уже получен - этот параметр не обязателен)
$login = 'login';

//...пароль для пользовательской авторизации (необходим только для получения токена. если токен уже получен - этот параметр не обязателен)
$password = 'password';

//...список групп, откуда берём картинки
$groups = array(-168416289, -168416289, -168416289);

//...слова для фильтрации (чтобы не отправить рекламную картинку/конкурс и тд)
$stop_words = array('конкурс','розыгрыш','приз','итоги','результаты');

...

//Строка для подтверждения адреса сервера из настроек Callback API
$confirmationToken = 'confirmationToken';

//Ключ доступа сообщества
$token = 'token';

// Secret key
$secretKey = 'secretKey';
...
```

Где взять эти параметры
------------
![Где взять эти параметры](https://sun1-12.userapi.com/c824203/v824203252/1a928a/EhoN1g4Gvjw.jpg)

Во вкладке "Типы событий" поставить галочки:
*Входящее сообщение
*Выход из сообщества
Внимание
------------
Токен, полученный методом прямой авторизации, работает безвременно.
То есть достаточно получить его однократно.
А нижележащий кусок кода можно закомментировать или удалить.
$client_id и $client_secret были найдены в свободном доступе в интернете.
Подробнее о прямой авторизации:
[https://vk.com/dev/auth_direct](https://vk.com/dev/auth_direct)
```php
...
function getToken($client_id, $client_secret, $login, $password) {
	$file = 'access_token.txt';
	if (is_file($file)) {
		$accessToken = file_get_contents($file);
	} else {
		$getToken = json_decode(file_get_contents('https://oauth.vk.com/token?grant_type=password&client_id='.$client_id.'&client_secret='.$client_secret.'&username='.$login.'&password='.$password.'&v=5.37&2fa_supported=1'));
	    $accessToken = $getToken->access_token;
	}
	file_put_contents($file, $accessToken);
	return $accessToken;
}

$client_id = 3140623;

$client_secret = 'VeWdmVclDCtn6ihuP1nt';

$login = 'login';

$password = 'password';
...
```
Рекомендуется получить пользовательский токен один раз и вписать в код скрипта вот сюда:
```php
...
$accessToken = 'ваш access token';
...
```
Запуск
------------
После заполнения всех параметров, необходимо разместить ваш скрипт на сервере с поддержкой php и указать адрес расположения скрипта в группе: 
Группа -> Управление -> Работа с API -> Callback API -> Настройки сервера -> Адрес.
Жмём "Подтвердить", и ,если всё сделано верно, то появится надпись об успешном подтверждении.
После этого отправляем в сообщения группы письмо с ключевым словом и, если в ответ пришла картинка - значит всё работает правильно.